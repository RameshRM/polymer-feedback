<link rel="import" href="/bower_components/polymer/polymer.html">

<polymer-element name="x-feedback" attributes="commentsLabel feedbackLabel">
<template>
    <link rel="stylesheet" href="feedback.css">
    <div class="feedback">
        <input class="feedback-btn" type="button" value="Feedback"></input>
    </div>

    <div id="feedback-overlay" class="feedback-overlay {{visibility}}" >
        <div id="feedback-modal" class="feedback-modal {{visibility}}">
            <header>Feedback</header>
            <form id="feedback-form">
                <div>
                    <label class="blackout-label float-clear">
                        <span class="float-left"><b>Blackout</b> personal information: </span>
                        <input type="checkbox" class="blackout-check float-right"></input>
                    </label>
                </div>
                <h5 class="label">Tell us your comments or suggestions.</h5>

                <textarea rows="10" cols="10"></textarea>
                <section class="action-bar">

                    <input type="submit" value="Send" class="btn btn-g"/>

                    <input type="reset" value="Cancel" id="reset"/>

                </section>
            </form>
            <div class="feedback-confirm">
                <p>Thank you for <b>Submitting Feedback</b> </p>
                <form>
                    <input type="submit" value="Close" class="btn btn-g"/>
                </form>
            </div>
        </div>
    </div>
</template>

<script type="text/javascript">
    var _feedbackStates = {init:'init',prepare:'prepare',capture:'capture',complete:'complete',cancel:'cancelled'};

    Polymer('x-feedback', {
        state:{},
        visibility:'hidden',
        config: {

        },
        ready: function() {
            var self = this;
            this.addEventListener("click", function() {
                self.state = _feedbackStates.init;
            });
            this.$['feedback-form'].addEventListener("reset",function(){
                self.notifyEvent(_feedbackStates.cancel);
            });
            this.$['feedback-form'].addEventListener("submit",function(e){
                self.notifyEvent(_feedbackStates.complete);
                e.preventDefault(true);
            });
            highlightor.highlight(this.$['feedback-overlay']);
        },
        stateChanged: function(){
            var data = null;
            if(this.state === _feedbackStates.init){
                this.visibility = "visible";
            }else if(this.state === _feedbackStates.cancel){
                this.visibility = "hidden";
                this.clearState();
            }else if(this.state === _feedbackStates.complete){
                data = this.screenCapture();
                this.visibility = "hidden";
            }
            var feedbackEvent = new CustomEvent("x-feedback",{"detail":data, state: this.state});
            document.dispatchEvent(feedbackEvent);
        },
        clearState: function(){
            var $parent = this.$['feedback-overlay'];
            var highlights = $parent.querySelectorAll(".highlightor");
            for(var i=highlights.length;i>=0;i--){
                if(typeof highlights[i] !== "undefined"){
                    $parent.removeChild(highlights[i]);
                }
            }
        },
        notifyEvent : function(currentState){
            this.state = currentState;
        },
        screenCapture: function(){
            return screenshotPage();
        }
    });
</script>

<script type="text/javascript" src="feedback.js"></script>
<script type="text/javascript" src="screenshot.js"></script>
<script type="text/javascript" src="highlightor.js"></script>
</polymer-element>

